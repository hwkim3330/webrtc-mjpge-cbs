<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watch - MJPEG Stream</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: #f5f5f7;
      min-height: 100vh;
      color: #1d1d1f;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      max-width: 1800px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 { font-size: 1.5rem; font-weight: 600; }
    .back-btn {
      padding: 8px 16px;
      background: #fff;
      color: #0071e3;
      text-decoration: none;
      border-radius: 980px;
      font-size: 0.85rem;
      border: 1px solid #d2d2d7;
    }
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 1800px;
      margin: 0 auto;
    }
    @media (max-width: 1200px) {
      .main-grid { grid-template-columns: 1fr; }
    }
    .panel {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    .panel h2 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1d1d1f;
    }
    .stream-container {
      position: relative;
      width: 100%;
      min-height: 360px;
      background: #1d1d1f;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stream-container img {
      width: 100%;
      height: auto;
      display: block;
    }
    .no-stream {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #86868b;
      padding: 40px;
    }
    .no-stream svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.4; }
    .no-stream p { font-size: 0.9rem; }
    .status {
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      font-weight: 500;
      margin-bottom: 16px;
      font-size: 0.85rem;
    }
    .status.waiting { background: #f5f5f7; color: #86868b; }
    .status.connected { background: rgba(52,199,89,0.1); color: #34c759; }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .chart-box {
      background: #f5f5f7;
      border-radius: 12px;
      padding: 14px;
    }
    .chart-box h3 {
      font-size: 0.75rem;
      color: #86868b;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .chart-wrapper { height: 100px; }
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f5f5f7;
      font-size: 0.85rem;
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-label { color: #86868b; }
    .stat-value { font-weight: 600; color: #0071e3; }
    .direct-url {
      margin-top: 16px;
      padding: 12px;
      background: #f5f5f7;
      border-radius: 10px;
      font-size: 0.8rem;
    }
    .direct-url label { color: #86868b; display: block; margin-bottom: 4px; }
    .direct-url code { color: #0071e3; word-break: break-all; font-size: 0.75rem; }
    .codec-badge {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(0,113,227,0.1);
      color: #0071e3;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Viewer <span class="codec-badge">MJPEG</span></h1>
    <a href="/" class="back-btn">Back</a>
  </div>

  <div class="main-grid">
    <div class="panel">
      <h2>Live Stream</h2>
      <div class="stream-container">
        <img id="streamImg" src="/stream.mjpg" alt="Stream" style="display:none;">
        <div id="noStream" class="no-stream">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
          </svg>
          <p>Waiting for broadcaster...</p>
        </div>
      </div>
      <div class="direct-url">
        <label>Direct Stream URL</label>
        <code id="streamUrl"></code>
      </div>
    </div>

    <div class="panel">
      <div id="status" class="status waiting">Waiting</div>
      <h2>Live Stats</h2>
      <div class="charts-grid">
        <div class="chart-box">
          <h3>Bitrate (Mbps)</h3>
          <div class="chart-wrapper"><canvas id="bitrateChart"></canvas></div>
        </div>
        <div class="chart-box">
          <h3>Frame Rate (fps)</h3>
          <div class="chart-wrapper"><canvas id="fpsChart"></canvas></div>
        </div>
        <div class="chart-box">
          <h3>Latency (ms)</h3>
          <div class="chart-wrapper"><canvas id="latencyChart"></canvas></div>
        </div>
        <div class="chart-box">
          <h3>Frame Size (KB)</h3>
          <div class="chart-wrapper"><canvas id="frameSizeChart"></canvas></div>
        </div>
      </div>
      <div style="margin-top:16px;">
        <div class="stat-row"><span class="stat-label">Current Bitrate</span><span class="stat-value" id="bitrate">-</span></div>
        <div class="stat-row"><span class="stat-label">Current FPS</span><span class="stat-value" id="fps">-</span></div>
        <div class="stat-row"><span class="stat-label">Current Latency</span><span class="stat-value" id="latency">-</span></div>
        <div class="stat-row"><span class="stat-label">Frame Size</span><span class="stat-value" id="frameSize">-</span></div>
        <div class="stat-row"><span class="stat-label">Frames Received</span><span class="stat-value" id="framesReceived">-</span></div>
        <div class="stat-row"><span class="stat-label">Total Received</span><span class="stat-value" id="bytesReceived">-</span></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const streamImg = document.getElementById('streamImg');
    const noStreamEl = document.getElementById('noStream');
    const statusEl = document.getElementById('status');

    document.getElementById('streamUrl').textContent = location.origin + '/stream.mjpg';

    const MAX_POINTS = 60;
    const statsData = { bitrate: [], fps: [], latency: [], frameSize: [], labels: [] };

    const chartOpts = {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 0 },
      scales: {
        x: { display: false },
        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 9 }, color: '#86868b' } }
      },
      plugins: { legend: { display: false } },
      elements: { point: { radius: 0 }, line: { tension: 0.3, borderWidth: 2 } }
    };

    function makeChart(id, color) {
      return new Chart(document.getElementById(id), {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: color, backgroundColor: color + '20', fill: true }] },
        options: chartOpts
      });
    }

    const charts = {
      bitrate: makeChart('bitrateChart', '#0071e3'),
      fps: makeChart('fpsChart', '#34c759'),
      latency: makeChart('latencyChart', '#ff9500'),
      frameSize: makeChart('frameSizeChart', '#af52de')
    };

    function updateCharts() {
      Object.keys(charts).forEach(key => {
        charts[key].data.labels = statsData.labels;
        charts[key].data.datasets[0].data = statsData[key];
        charts[key].update('none');
      });
    }

    socket.emit('viewer');

    socket.on('broadcaster-status', (broadcasting) => {
      if (broadcasting) {
        streamImg.style.display = 'block';
        noStreamEl.style.display = 'none';
        statusEl.textContent = 'Connected';
        statusEl.className = 'status connected';
      } else {
        streamImg.style.display = 'none';
        noStreamEl.style.display = 'flex';
        statusEl.textContent = 'Waiting';
        statusEl.className = 'status waiting';
      }
    });

    let lastFrameTime = Date.now();
    let reconnectTimer = null;

    streamImg.onload = () => {
      noStreamEl.style.display = 'none';
      streamImg.style.display = 'block';
      statusEl.textContent = 'Connected';
      statusEl.className = 'status connected';
      lastFrameTime = Date.now();
    };

    streamImg.onerror = () => {
      console.log('Stream error, reconnecting...');
      setTimeout(() => { streamImg.src = '/stream.mjpg?' + Date.now(); }, 1000);
    };

    // 프레임 수신 시 타임스탬프 갱신
    socket.on('frame-stats', () => {
      lastFrameTime = Date.now();
    });

    // 5초 동안 프레임 없으면 자동 재연결
    setInterval(() => {
      const elapsed = Date.now() - lastFrameTime;
      if (elapsed > 5000 && streamImg.style.display === 'block') {
        console.log('No frames for 5s, reconnecting...');
        statusEl.textContent = 'Reconnecting...';
        statusEl.className = 'status waiting';
        streamImg.src = '/stream.mjpg?' + Date.now();
      }
    }, 2000);

    let totalFrames = 0;
    let totalBytes = 0;

    // Real-time frame stats from server
    let lastSocketTime = Date.now();
    let socketLatency = 0;

    socket.on('frame-stats', (data) => {
      const now = Date.now();
      // Socket message interval (approximates real-time delivery)
      const interval = now - lastSocketTime;
      lastSocketTime = now;

      // Use broadcaster->server latency directly (most accurate)
      // This is measured on same machine, no clock sync issues
      const displayLatency = data.latency;

      totalFrames++;
      totalBytes += data.frameSize;

      document.getElementById('fps').textContent = data.fps + ' fps';
      document.getElementById('latency').textContent = displayLatency + ' ms';
      document.getElementById('frameSize').textContent = (data.frameSize / 1024).toFixed(1) + ' KB';
      document.getElementById('framesReceived').textContent = totalFrames.toLocaleString();
      document.getElementById('bytesReceived').textContent = formatBytes(totalBytes);

      statsData.latency.push(displayLatency);
      statsData.fps.push(data.fps);
      statsData.frameSize.push(data.frameSize / 1024);

      if (statsData.latency.length > MAX_POINTS) {
        statsData.latency.shift();
        statsData.fps.shift();
        statsData.frameSize.shift();
      }
    });

    // Bitrate from broadcaster
    socket.on('broadcast-stats', (data) => {
      document.getElementById('bitrate').textContent = (data.bitrate / 1000000).toFixed(2) + ' Mbps';
      statsData.labels.push('');
      statsData.bitrate.push(data.bitrate / 1000000);

      if (statsData.labels.length > MAX_POINTS) {
        statsData.labels.shift();
        statsData.bitrate.shift();
      }
      updateCharts();
    });

    function formatBytes(b) {
      if (b >= 1073741824) return (b / 1073741824).toFixed(2) + ' GB';
      if (b >= 1048576) return (b / 1048576).toFixed(2) + ' MB';
      if (b >= 1024) return (b / 1024).toFixed(2) + ' KB';
      return b + ' B';
    }
  </script>
</body>
</html>
